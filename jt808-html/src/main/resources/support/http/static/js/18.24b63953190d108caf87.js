webpackJsonp([18],{QbFr:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=i("mvHQ"),s=i.n(o),n=i("/bhr"),a=(i("TFOu"),i("ow4a")),l=i("d2xA"),r=i("Zwc7"),c=i("3t5t"),h=i("YwP3"),d=i("B5xV"),p={name:"PostsitionRealtime",data:function(){return{websocket0x0200URL:"",websocket:null,carImgArr:["/car6.png","/car1.png","/car2.png","/car3.png","/car4.png","/car5.png","/car6.png"],center:{lng:116.396621,lat:39.916385},zoom:13,cars:[],lastTid:"",lastCar:{},isShowInfoWindow:!0,showTid:"",islbbclick:!0,isrbbclick:!0,leftWidth:260,bottomHeight:300,hashMap:new n.a.HashMap}},methods:{move1:function(t,e){this.leftWidth=this.leftWidth+(e.x-t.x),this.bottomHeight=this.bottomHeight+(t.y-e.y),localStorage.setItem("leftWidth",this.leftWidth),localStorage.setItem("bottomHeight",this.bottomHeight)},getCarIcon:function(t){return"/static/images/"+(t.icon_type?t.icon_type:"car_icon_0")+this.carImgArr[t.status_jt808]},lbbclick:function(t){this.islbbclick=t},rbbclick:function(t){this.isrbbclick=t},isShowInfoWindow1:function(t){this.isShowInfoWindow=t,t?this.showTid&&this.hashMap.get(this.showTid).openInfoWindow():this.showTid&&this.hashMap.get(this.showTid).closeInfoWindow()},getClickInfo:function(t){this.center.lng=t.point.lng,this.center.lat=t.point.lat},lingxnodeclick:function(t,e,i){this.setCarCenter(t.value)},lingxcheckchange:function(t,e,i){var o=this;if(e){this.lastTid=t.value,this.showTid=this.lastTid;var s={cmd:1005,tid:t.value};this.websocketsend(s),(t.value+"").length<10&&149!=t.value&&this.callApi({apicode:1136,groupId:t.value},function(t){for(var e=0;e<t.data.length;e++)o.websocketsend({cmd:1005,tid:t.data[e].value})})}else{s={cmd:1006,tid:t.value};if(this.websocketsend(s),this.delCar(t.value),i)return;(t.value+"").length<10&&149!=t.value&&this.callApi({apicode:1136,groupId:t.value},function(t){for(var e=0;e<t.data.length;e++)o.websocketsend({cmd:1006,tid:t.data[e].value}),o.delCar(t.data[e].value)})}},addCar:function(t){if(t&&"0x0200"==t.type){t.carno||(t.carno=t.tid),t.carno.indexOf(" ")>0&&(t.carno=t.carno.substring(0,t.carno.indexOf(" ")));for(var e=-1,i=0;i<this.cars.length;i++)t.tid==this.cars[i].tid&&(e=i);-1==e?this.cars.push(t):this.$set(this.cars,e,t),this.lastTid==t.tid?(this.center={lng:t.lng_offset,lat:t.lat_offset},this.lastCar=t,this.lastTid=""):this.lastCar.tid==t.tid&&(this.lastCar=t)}},delCar:function(t){for(var e=-1,i=0;i<this.cars.length;i++)t==this.cars[i].tid&&(e=i);e>-1&&this.cars.splice(e,1),this.lastCar.tid==t&&(this.lastCar={})},tableclickHandler:function(t,e,i){this.setCarCenter(t.tid)},setCarCenter:function(t){this.showTid=t;this.isShowInfoWindow&&this.hashMap.get(t)&&this.hashMap.get(t).openInfoWindow();for(var e=0;e<this.cars.length;e++)t==this.cars[e].tid&&(this.lastCar=this.cars[e],this.center={lng:this.cars[e].lng_offset,lat:this.cars[e].lat_offset})},formatCarno:function(t){return t.indexOf(" ")>0&&(t=t.substring(0,t.indexOf(" "))),t},formatOnline:function(t){return 1==t?"<span style='color:green'>在线</span>":"<span style='color:red'>离线</span>"},formatAcc:function(t){return!0&t?"<span style='color:green'>点火</span>":"<span style='color:red'>熄火</span>"},formatAlarm:function(t){return"无"==t?"无":"<span style='color:red'>"+t+"</span>"},formatDatetime:function(t,e,i,o){return i?i.substring(0,4)+"-"+i.substring(4,6)+"-"+i.substring(6,8)+" "+i.substring(8,10)+":"+i.substring(10,12)+":"+i.substring(12,14):""},initWebsocket:function(){console.log(this.websocket0x0200URL);var t=this.websocket0x0200URL;this.websocket=new WebSocket(t),this.websocket.onmessage=this.websocketonmessage,this.websocket.onopen=this.websocketonopen,this.websocket.onerror=this.websocketonerror,this.websocket.onclose=this.websocketclose},websocketonopen:function(){},websocketonerror:function(){this.initWebSocket()},websocketonmessage:function(t){var e=JSON.parse(t.data);this.addCar(e),this.$refs.lingxCarTree.updateTreeNode(e)},websocketsend:function(t){t.lingxtoken=this.$store.getters.getUser.token,this.websocket.send(s()(t))},websocketclose:function(t){console.log("断开连接",t);var e=this;setTimeout(function(){e.initWebsocket()},3e3)},formatTxxh:function(t,e,i,o){if(i){return i<10?i+"-弱":i<20?i+"-中":i+"-强"}return 0},formatDwxh:function(t,e,i,o){if(i){return i<4?i+"-弱":i<7?i+"-中":i+"-强"}return 0},openRealtimeSingleDialog:function(t,e){this.$refs.realtimeSingle.open(t,e)},openHistoryDialog:function(t,e){this.$emit("parentFun","handleSelectMenu","/main/postsitionhistory?carid="+t+"&carno="+e,e),this.$router.push({path:"/main/postsitionhistory",query:{carid:t,carno:e}})},openXcjlGridDialog:function(t,e){this.$refs.xcjlGridDialog.openDialog(t,e)},openCmdListDialog:function(t,e){this.$refs.cmdListDialog.openDialog(t,e+"-指令下发",1)},openParListDialog:function(t,e){this.$refs.cmdListDialog.openDialog(t,e+"-参数设置",2)},copyFun:function(){var t=document.createElement("textarea");t.style.position="absolute",t.style.left="-100%",t.value="车辆标识："+this.lastCar.carno+"\n行驶速度："+this.lastCar.speed+" KM/H\n系统时间："+this.formatDatetime(1,1,this.lastCar.systime,1)+"\n卫星时间："+this.formatDatetime(1,1,this.lastCar.gpstime,1)+"\n车辆状态："+this.lastCar.status_str+"\n当前告警："+this.lastCar.alarm_str+"\n",this.lastCar.is_address&&(t.value+="当前地址："+this.lastCar.address),document.body.appendChild(t),t.select(),document.execCommand("copy")?this.lgxInfo("复制成功"):this.lgxInfo2("复制失败"),document.body.removeChild(t)},closeWin:function(){this.$refs.lingxMap.setIsShowInfoWindow(!1)},getRotation:function(t){return(360-t+360)%360},getWinInfo:function(t){var e='<div style="width:420px;font-size:14px;line-height: 28px;margin:0px;padding:0px;"><table  width="100%" border="0" cellSpacing="0" cellPadding="0"><tr style="background-color: #f9f9f9;"><td style="color: #999999;width:64px;">车辆标识:</td><td ><div style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width:120px;" title="'+t.carno+'">'+t.carno+'</div></td><td style="color: #999999;width:64px;">系统时间:</td><td  width="150">'+this.formatDatetime(1,1,t.systime,1)+'</td></tr><tr><td style="color: #999999;">行驶速度:</td><td>'+t.speed+' km/h</td><td style="color: #999999;">卫星时间:</td><td>'+this.formatDatetime(1,1,t.gpstime,1)+'</td></tr><tr style="background-color: #f9f9f9;"><td style="color: #999999;">车辆状态:</td><td colspan="1"><div style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width:120px;" title="'+t.status_str+'">'+t.status_str+'</div></td><td style="color: #999999;width:64px;">在线状态:</td><td><div style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width:120px;" title="'+t.comment+'">'+t.comment+'</div></td></tr><tr><td style="color: #999999;">当前告警:</td><td colspan="3">'+("无"==t.alarm_str?"无":'<span style="color:red">'+t.alarm_str+"</span>")+"</td></tr>";return t.is_address&&(e+='<tr style="background-color: #f9f9f9;"><td style="color: #999999;" valign="top">当前地址:</td><td colspan="3"><div style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width:350px;" title="'+t.address+'">'+(t.address||"无")+"</div></td></tr>"),e+='<tr><td colspan="4"> <a class="el-link el-link--primary is-underline" onclick="m2(\''+t.tid+"','"+t.carno+'\')">\x3c!----\x3e<span class="el-link--inner">历史轨迹</span>\x3c!----\x3e</a> | <a class="el-link el-link--success is-underline" onclick="m3(\''+t.tid+"','"+t.carno+'\')">\x3c!----\x3e<span class="el-link--inner">下发指令</span>\x3c!----\x3e</a> | <a class="el-link el-link--warning is-underline" onclick="m5(\''+t.tid+"','"+t.carno+'\')">\x3c!----\x3e<span class="el-link--inner">复制信息</span>\x3c!----\x3e</a>  | <a class="el-link el-link--info is-underline" onclick="m6(\''+t.tid+"','"+t.carno+'\')">\x3c!----\x3e<span class="el-link--inner">关闭窗口</span>\x3c!----\x3e</a></td></td></tr></table></div>'}},created:function(){this.leftWidth=(localStorage.getItem("leftWidth")||"260")-0,this.bottomHeight=(localStorage.getItem("bottomHeight")||"300")-0,this.leftWidth||(this.leftWidth=260),this.bottomHeight||(this.bottomHeight=300),this.leftWidth>600&&(this.leftWidth=600),this.bottomHeight>600&&(this.bottomHeight=600),this.hashMap=new n.a.HashMap;var t=this;this.callApi({apicode:1102},function(e){t.websocket0x0200URL=e.data.websocket0x0200URL;var i=e.data.centerLatlng.split(",");t.center={lat:i[0]-0,lng:i[1]-0},i.length>2&&(t.zoom=i[2]-0),t.initWebsocket()})},mounted:function(){this.map=this.$refs.lingxMap.getMap(),this.layer=new a.k("vector").addTo(this.map),window.m1=this.openRealtimeSingleDialog,window.m2=this.openHistoryDialog,window.m3=this.openCmdListDialog,window.m4=this.openParListDialog,window.m5=this.copyFun,window.m6=this.closeWin},destroyed:function(){this.websocket.close()},watch:{cars:function(t,e){for(var i=this,o=new n.a.HashMap,s=0;s<t.length;s++){var l=t[s];if(null!=l&&null!=l.lng_offset){var r;if(o.put(l.tid,l.tid),this.hashMap.containsKey(l.tid))(r=this.hashMap.get(l.tid)).setCoordinates([l.lng_offset-0,l.lat_offset-0]),r.setSymbol([{markerFile:i.getCarIcon(l),markerWidth:40,markerHeight:40,markerDx:0,markerDy:20,markerOpacity:1,markerRotation:i.getRotation(l.direction)},{textName:"{name}",textSize:14,textDy:-24,textFill:"#004e98",textWeight:"bold"}]),r.setProperties({name:l.carno}),r.setInfoWindow({content:i.getWinInfo(l),autoPan:!1,width:450,minHeight:120,autoOpenOn:"none",autoCloseOn:"none"});else(r=new a.h([l.lng_offset-0,l.lat_offset-0],{id:l.tid,properties:{name:l.carno},symbol:[{markerFile:i.getCarIcon(l),markerWidth:40,markerHeight:40,markerDx:0,markerDy:20,markerOpacity:1,markerRotation:i.getRotation(l.direction)},{textName:"{name}",textSize:14,textDy:-24,textFill:"#004e98",textWeight:"bold"}]}).addTo(this.layer)).on("click",function(t){i.showTid=t.target._id,i.isShowInfoWindow?t.target.openInfoWindow():i.$refs.lingxMap.setIsShowInfoWindow(!0)}),r.setInfoWindow({content:i.getWinInfo(l),autoPan:!1,width:450,minHeight:120,autoOpenOn:"none",autoCloseOn:"none"}),this.hashMap.put(l.tid,r),i.isShowInfoWindow&&r.openInfoWindow();var c=l;this.lastTid==c.tid&&(this.center.lng=c.lng_offset,this.center.lat=c.lat_offset,this.lastCar=c,this.lastTid="")}}var h=this.hashMap.keySet();for(s=0;s<h.length;s++)o.containsKey(h[s])||(this.hashMap.get(h[s]).remove(),this.hashMap.remove(h[s]));i.isShowInfoWindow&&this.hashMap.get(this.showTid)&&this.hashMap.get(this.showTid).openInfoWindow()},center:function(t,e){null!=t&&null!=t.lng&&this.map.setCenter([t.lng,t.lat])}},components:{LingxCarTree:r.a,RealtimeSingle:d.default,XcjlGridDialog:h.default,CmdListDialog:c.default,LingxMap:l.a}},f={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("el-container",{staticStyle:{height:"100%"}},[i("el-aside",{directives:[{name:"show",rawName:"v-show",value:t.islbbclick,expression:"islbbclick"}],staticStyle:{"background-color":"#fff","border-right":"#c1c5cd 1px solid"},attrs:{width:t.leftWidth+"px"}},[i("LingxCarTree",{ref:"lingxCarTree",attrs:{isStatus:!0,isReload:!0},on:{lingxcheckchange:t.lingxcheckchange,lingxnodeclick:t.lingxnodeclick}})],1),t._v(" "),i("el-container",{staticStyle:{width:"100%",height:"100%",margin:"0px",padding:"0px"}},[i("el-main",{staticStyle:{margin:"0px",padding:"0px"}},[i("LingxMap",{ref:"lingxMap",attrs:{zoom:t.zoom,center:t.center,isLeftBottmButton1:!0,isRightBottmButton1:!0},on:{move:t.move1,isShowInfoWindow:t.isShowInfoWindow1,lbbclick:t.lbbclick,rbbclick:t.rbbclick}})],1),t._v(" "),i("el-footer",{directives:[{name:"show",rawName:"v-show",value:t.islbbclick&&t.isrbbclick,expression:"islbbclick&&isrbbclick"}],staticStyle:{"background-color":"#fff",padding:"0px"},attrs:{height:t.bottomHeight+"px"}},[i("el-table",{staticStyle:{width:"100%"},attrs:{size:"mini",height:t.bottomHeight,stripe:"","highlight-current-row":"",data:t.cars},on:{"row-click":t.tableclickHandler}},[i("el-table-column",{attrs:{label:"",width:"36px"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n                        "+t._s(e.$index+1)+"\n                    ")]}}])}),t._v(" "),i("el-table-column",{attrs:{prop:"carno",sortable:"",label:"车辆标识",width:"150","show-overflow-tooltip":""}}),t._v(" "),i("el-table-column",{attrs:{prop:"online",sortable:"",label:"在线",width:"70"},scopedSlots:t._u([{key:"default",fn:function(e){return[i("div",{domProps:{innerHTML:t._s(t.formatOnline(e.row.online))}})]}}])}),t._v(" "),i("el-table-column",{attrs:{prop:"status_str",label:"车辆状态",width:"120","show-overflow-tooltip":""}}),t._v(" "),i("el-table-column",{attrs:{prop:"alarm_str",label:"当前告警",width:"120","show-overflow-tooltip":""},scopedSlots:t._u([{key:"default",fn:function(e){return[i("div",{domProps:{innerHTML:t._s(t.formatAlarm(e.row.alarm_str))}})]}}])}),t._v(" "),i("el-table-column",{attrs:{prop:"speed",label:"时速KM/H",width:"80"}}),t._v(" "),i("el-table-column",{attrs:{prop:"gpstime",sortable:"",label:"定位时间",width:"160",formatter:t.formatDatetime}}),t._v(" "),i("el-table-column",{attrs:{prop:"dtlc",sortable:"",label:"当天里程KM",width:"120"}}),t._v(" "),i("el-table-column",{attrs:{prop:"A01",sortable:"",label:"总里程KM",width:"100"}}),t._v(" "),i("el-table-column",{attrs:{prop:"height",sortable:"",label:"高程M",width:"80"}}),t._v(" "),i("el-table-column",{attrs:{prop:"A30",sortable:"",label:"通信信号",width:"100",formatter:t.formatTxxh}}),t._v(" "),i("el-table-column",{attrs:{prop:"A31",sortable:"",label:"定位信号",width:"100",formatter:t.formatDwxh}}),t._v(" "),i("el-table-column",{attrs:{prop:"tid","show-overflow-tooltip":"",label:"设备号",width:"120"}}),t._v(" "),i("el-table-column",{attrs:{prop:"address","show-overflow-tooltip":"",label:"地址"}}),t._v(" "),i("el-table-column",{attrs:{prop:"lng","show-overflow-tooltip":"",label:"经度"}}),t._v(" "),i("el-table-column",{attrs:{prop:"lat","show-overflow-tooltip":"",label:"纬度"}})],1),t._v(" "),i("RealtimeSingle",{ref:"realtimeSingle"}),t._v(" "),i("XcjlGridDialog",{ref:"xcjlGridDialog"}),t._v(" "),i("CmdListDialog",{ref:"cmdListDialog"})],1)],1)],1)},staticRenderFns:[]};var g=i("VU/8")(p,f,!1,function(t){i("p9AJ")},null,null);e.default=g.exports},p9AJ:function(t,e){}});