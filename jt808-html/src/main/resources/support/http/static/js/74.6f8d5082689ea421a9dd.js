webpackJsonp([74],{"7mpa":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n("eEqi"),a=n.n(o),i=n("ue5y"),l=n.n(i),r={name:"TalkDialog",props:{deviceId:{type:String,default:""}},data:function(){return{tdh:1,dialogVisible:!1,talkImg:a.a,info:"",isTalking:!1,options:[{label:"通道1",value:1},{label:"通道2",value:2},{label:"通道3",value:3},{label:"通道4",value:4},{label:"通道5",value:5},{label:"通道6",value:6},{label:"通道7",value:7},{label:"通道8",value:8}]}},methods:{start:function(){var e=this;this.talkImg=l.a,this.isTalking=!0,this.lgxInfo("正在启动对讲中，请稍候..."),this.callApi({apicode:1132,deviceId:this.deviceId,channel:this.tdh},function(t){e.lgxInfo("已成功连接服务器，可以开始对讲！"),s.start(t.pull_address)})},stop:function(){this.talkImg=a.a,this.isTalking=!1,this.lgxInfo("正在关闭对讲！"),s.stop(),this.callApi({apicode:1133,deviceId:this.deviceId,channel:1},function(e){})},openDialog:function(){this.dialogVisible=!0},handleClose:function(e){this.dialogVisible=!1}}},s=new function(){document.getElementById("audio_info");var e,t=document.createElement("audio"),n=document.createElement("audio"),o=[],a=0,i=null,l=[],r=!0;this.start=function(s){if(document.getElementById("audio_info")&&(document.getElementById("audio_info").innerHTML="正在连接对讲服务器..."),(e=new WebSocket(s)).onopen=function(){console.log("音频对讲websoket已连接"),document.getElementById("audio_info")&&(document.getElementById("audio_info").innerHTML="音频对讲websoket已连接")},e.onmessage=function(e){var o=e.data;if(o instanceof Blob&&(l.push(o),25==l.length)){console.log("已收到一秒音频："+(new Date).getTime()),document.getElementById("audio_info")&&(document.getElementById("audio_info").innerHTML="已收到一秒音频："+(new Date).format("yyyy-MM-dd HH:mm:ss"));var a=new Blob(l),i=new FileReader;i.readAsArrayBuffer(a),i.onload=function(e){var o=i.result,a=new DataView(o);r?(t.src=window.URL.createObjectURL(c(a)),t.play()):(n.src=window.URL.createObjectURL(c(a)),n.play()),r=!r},l=[]}},e.onclose=function(){i&&i.disconnect(),console.log("音频对讲websoket已关闭"),document.getElementById("audio_info")&&(document.getElementById("audio_info").innerHTML="对讲服务器已断开连接。")},!navigator.getUserMedia)return alert("抱歉, 您的设备无法语音对讲"),!1;o=[],a=0;var u=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext);(i=u.createScriptProcessor(4096,1,1)).onaudioprocess=function(t){var n=t.inputBuffer.getChannelData(0);o.push(new Float32Array(n)),a+=n.length,function(){if(0!==a){var t=d();if(t){var n=new Blob([t]);e.send(n)}}}(),o=[],a=0};var f=null;navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){f=u.createMediaStreamSource(e)}).catch(function(e){console.log("error")}).then(function(){f.connect(i),i.connect(u.destination)})},this.stop=function(){e.close()};var s=16;function d(){var e=function(){for(var e=new Float32Array(a),t=0,n=0;n<o.length;n++)e.set(o[n],t),t+=o[n].length;var i=parseInt(6),l=e.length/i,r=new Float32Array(l),s=0,d=0;for(;s<l;)r[s]=e[d],d+=i,s++;return r}(),t=s,n=0,i=e.length*(t/8),l=new ArrayBuffer(i),r=new DataView(l);if(!(i>65535)){if(8===t)for(var d=0;d<e.length;d++,n++){var c=Math.max(-1,Math.min(1,e[d])),u=c<0?128*c:127*c;u=parseInt(u+128),r.setInt8(n,u,!0)}else for(var d=0;d<e.length;d++,n+=2){var c=Math.max(-1,Math.min(1,e[d]));r.setInt16(n,c<0?32768*c:32767*c,!0)}return r}console.log("数据过长："+i)}function c(e){var t=e.byteLength,n=new ArrayBuffer(44+t),o=new DataView(n),a=0,i=function(e){for(var t=0;t<e.length;t++)o.setUint8(a+t,e.charCodeAt(t))};i("RIFF"),a+=4,o.setUint32(a,36+t,!0),a+=4,i("WAVE"),a+=4,i("fmt "),a+=4,o.setUint32(a,16,!0),a+=4,o.setUint16(a,6,!0),a+=2,o.setUint16(a,1,!0),a+=2,o.setUint32(a,8e3,!0),a+=4,o.setUint32(a,16e3,!0),a+=4,o.setUint16(a,2,!0),a+=2,o.setUint16(a,16,!0),a+=2,i("data"),a+=4,o.setUint32(a,t,!0),a+=4;for(var l=0;l<t;l++)o.setInt8(a,e.getInt8(l),!0),a++;return new Blob([o],{type:"audio/wav"})}};var d={render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[e.dialogVisible?n("el-dialog",{directives:[{name:"dialogDrag",rawName:"v-dialogDrag"}],attrs:{title:"实时对讲",visible:e.dialogVisible,width:"720px",height:"480px","show-close":"","append-to-body":"","close-on-click-modal":!1,"before-close":e.handleClose}},[n("div",{staticStyle:{width:"100%",height:"380px",overflow:"auto","background-color":"#dfe9f6","text-align":"center"}},[n("div",[n("br"),e._v(" "),n("center",[n("div",{attrs:{id:"audio_info"}})]),e._v(" "),n("br"),e._v(" "),n("img",{attrs:{src:e.talkImg}}),n("br"),e._v(" "),n("el-select",{staticStyle:{width:"90px"},attrs:{placeholder:"请选择"},model:{value:e.tdh,callback:function(t){e.tdh=t},expression:"tdh"}},e._l(e.options,function(e){return n("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})}),1),e._v(" "),n("el-button",{attrs:{type:"primary",disabled:e.isTalking},on:{click:e.start}},[e._v("启动对讲")]),e._v(" "),n("el-button",{attrs:{type:"danger",disabled:!e.isTalking},on:{click:e.stop}},[e._v("关闭对讲")])],1)]),e._v(" "),n("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[n("el-button",{on:{click:e.handleClose}},[e._v("关 闭")])],1)]):e._e()],1)},staticRenderFns:[]};var c=n("VU/8")(r,d,!1,function(e){n("JqzA")},null,null);t.default=c.exports},JqzA:function(e,t){}});